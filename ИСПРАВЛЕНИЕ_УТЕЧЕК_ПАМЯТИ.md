# Исправление утечек памяти при работе с 3D моделями

## Проблема

При переходах по страницам с экспонатами наблюдалось динамическое засорение ОЗУ - использование памяти вкладкой доходило до нескольких гигабайт. Проблема была связана с отсутствием очистки ресурсов Three.js при размонтировании компонентов.

## Что было исправлено

### 1. ModelViewer.tsx
- ✅ Добавлена функция `disposeScene()` для очистки всех ресурсов Three.js (геометрии, материалы, текстуры)
- ✅ Добавлена очистка предыдущей сцены перед созданием новой
- ✅ Добавлен `useEffect` с cleanup функцией для освобождения ресурсов при размонтировании
- ✅ Добавлен `key` в компоненте для полного пересоздания при смене модели
- ✅ Добавлена очистка WebGL контекста при размонтировании

### 2. SafeModel.tsx
- ✅ Добавлена функция `disposeScene()` для очистки ресурсов
- ✅ Добавлена очистка предыдущей сцены перед созданием новой
- ✅ Добавлен `useEffect` с cleanup функцией для освобождения ресурсов при размонтировании

### 3. VirtualGallery.tsx
- ✅ Добавлен флаг `isMountedRef` для предотвращения выполнения `useFrame` после размонтирования
- ✅ Добавлена очистка состояния при размонтировании компонента `ExhibitInSpace`
- ✅ Добавлена очистка всех `setTimeout` таймеров при размонтировании
- ✅ Добавлена очистка WebGL контекста Canvas при размонтировании
- ✅ Добавлен флаг `isMountedRef` в `CameraBounds` для остановки `useFrame`

### 4. FirstPersonControls.tsx
- ✅ Добавлен флаг `isMountedRef` для остановки `useFrame` после размонтирования

### 5. MobileControls.tsx
- ✅ Добавлена очистка `requestAnimationFrame` при размонтировании

### 6. ModelThumbnail.tsx
- ✅ Добавлена функция `disposeScene()` для очистки ресурсов
- ✅ Добавлена очистка WebGL контекста при размонтировании
- ✅ Добавлена очистка IntersectionObserver

### 7. ModelThumbnailRenderer.tsx
- ✅ Добавлена функция `disposeScene()` для очистки ресурсов
- ✅ Добавлена очистка WebGL контекста при размонтировании
- ✅ Добавлена очистка `setTimeout` таймера

### 8. app/exhibit/[id]/page.tsx
- ✅ Добавлен `key={exhibit.id}` для ModelViewer, чтобы при смене экспоната компонент полностью пересоздавался

### 9. components/admin/ExhibitForm.tsx
- ✅ Добавлена очистка `setTimeout` таймеров при размонтировании

## Что очищается

При размонтировании компонентов теперь освобождаются:

### Three.js ресурсы:
- **Геометрии (geometries)** - через `geometry.dispose()`
- **Материалы (materials)** - через `material.dispose()`
- **Текстуры (textures)**:
  - `map` (основная текстура)
  - `normalMap` (карта нормалей)
  - `roughnessMap` (карта шероховатости)
  - `metalnessMap` (карта металличности)
  - `emissiveMap` (карта свечения)
  - `aoMap` (ambient occlusion карта)

### WebGL ресурсы:
- **WebGL контексты** - через `WEBGL_lose_context` extension
- **Canvas элементы** - очистка при размонтировании

### JavaScript ресурсы:
- **useFrame хуки** - остановка через `isMountedRef` флаг
- **setTimeout таймеры** - очистка через `clearTimeout`
- **requestAnimationFrame** - очистка через `cancelAnimationFrame`
- **Event listeners** - удаление через `removeEventListener`
- **IntersectionObserver** - отключение через `disconnect()`
- **React state** - очистка состояния при размонтировании

## Результат

После исправлений:
- ✅ Ресурсы Three.js корректно освобождаются при размонтировании компонентов
- ✅ WebGL контексты очищаются через `WEBGL_lose_context`
- ✅ Все таймеры (`setTimeout`) очищаются при размонтировании
- ✅ Все `requestAnimationFrame` отменяются при размонтировании
- ✅ Все `useFrame` хуки останавливаются через флаг `isMountedRef`
- ✅ Event listeners корректно удаляются
- ✅ IntersectionObserver отключается
- ✅ Память не накапливается при переходах между страницами
- ✅ Использование ОЗУ остается стабильным при длительной работе
- ✅ Производительность улучшена за счет правильной очистки ресурсов

## Рекомендации

1. **Мониторинг памяти**: Проверьте использование памяти в DevTools → Performance → Memory после исправлений
2. **Тестирование**: Перейдите по нескольким страницам с экспонатами и проверьте, что память не растет
3. **Дополнительная оптимизация**: Если проблема сохраняется, можно добавить ограничение на количество одновременно загруженных моделей в VirtualGallery

## Технические детали

### Функция `disposeScene()`

Функция `disposeScene()` рекурсивно обходит все объекты в сцене и освобождает:
- Все геометрии через `traverse()`
- Все материалы (как массивы, так и одиночные)
- Все текстуры, связанные с материалами

Это стандартный подход для предотвращения утечек памяти в Three.js приложений.

### Паттерны очистки

1. **useFrame хуки**: Используется флаг `isMountedRef` для проверки перед выполнением
2. **Таймеры**: Все `setTimeout` сохраняются в `useRef` и очищаются в cleanup функции
3. **WebGL контексты**: Используется `WEBGL_lose_context` extension для принудительной очистки
4. **Event listeners**: Все слушатели удаляются в cleanup функции `useEffect`
5. **React state**: Очищается через `setState(null)` в cleanup функции

### Проверка качества

Все компоненты проверены на:
- ✅ Очистку Three.js ресурсов
- ✅ Очистку WebGL контекстов
- ✅ Очистку таймеров
- ✅ Остановку анимационных циклов
- ✅ Удаление event listeners
- ✅ Очистку React state
