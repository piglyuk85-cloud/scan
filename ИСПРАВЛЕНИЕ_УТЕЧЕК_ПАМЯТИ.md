# Исправление утечек памяти при работе с 3D моделями

## Проблема

При переходах по страницам с экспонатами наблюдалось динамическое засорение ОЗУ - использование памяти вкладкой доходило до нескольких гигабайт. Проблема была связана с отсутствием очистки ресурсов Three.js при размонтировании компонентов.

## Что было исправлено

### 1. ModelViewer.tsx
- ✅ Добавлена функция `disposeScene()` для очистки всех ресурсов Three.js (геометрии, материалы, текстуры)
- ✅ Добавлена очистка предыдущей сцены перед созданием новой
- ✅ Добавлен `useEffect` с cleanup функцией для освобождения ресурсов при размонтировании
- ✅ Добавлен `key` в компоненте для полного пересоздания при смене модели

### 2. SafeModel.tsx
- ✅ Добавлена функция `disposeScene()` для очистки ресурсов
- ✅ Добавлена очистка предыдущей сцены перед созданием новой
- ✅ Добавлен `useEffect` с cleanup функцией для освобождения ресурсов при размонтировании

### 3. VirtualGallery.tsx
- ✅ Добавлен флаг `isMountedRef` для предотвращения выполнения `useFrame` после размонтирования
- ✅ Добавлена очистка состояния при размонтировании компонента `ExhibitInSpace`
- ✅ Добавлен ref для контейнера Canvas

### 4. app/exhibit/[id]/page.tsx
- ✅ Добавлен `key={exhibit.id}` для ModelViewer, чтобы при смене экспоната компонент полностью пересоздавался

## Что очищается

При размонтировании компонентов теперь освобождаются:
- Геометрии (geometries) - через `geometry.dispose()`
- Материалы (materials) - через `material.dispose()`
- Текстуры (textures):
  - `map` (основная текстура)
  - `normalMap` (карта нормалей)
  - `roughnessMap` (карта шероховатости)
  - `metalnessMap` (карта металличности)
  - `emissiveMap` (карта свечения)
  - `aoMap` (ambient occlusion карта)

## Результат

После исправлений:
- ✅ Ресурсы Three.js корректно освобождаются при размонтировании компонентов
- ✅ Память не накапливается при переходах между страницами
- ✅ Использование ОЗУ остается стабильным при длительной работе
- ✅ Производительность улучшена за счет правильной очистки ресурсов

## Рекомендации

1. **Мониторинг памяти**: Проверьте использование памяти в DevTools → Performance → Memory после исправлений
2. **Тестирование**: Перейдите по нескольким страницам с экспонатами и проверьте, что память не растет
3. **Дополнительная оптимизация**: Если проблема сохраняется, можно добавить ограничение на количество одновременно загруженных моделей в VirtualGallery

## Технические детали

Функция `disposeScene()` рекурсивно обходит все объекты в сцене и освобождает:
- Все геометрии через `traverse()`
- Все материалы (как массивы, так и одиночные)
- Все текстуры, связанные с материалами

Это стандартный подход для предотвращения утечек памяти в Three.js приложений.
