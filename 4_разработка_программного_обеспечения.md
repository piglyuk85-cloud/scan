# 4 Разработка программного обеспечения

## 4.1 Алгоритм решения задачи

Разработка веб-приложения осуществлялась по итеративному подходу с поэтапной реализацией функциональности.

### 4.1.1 Общий алгоритм работы системы

**Алгоритм работы с каталогом экспонатов:**

```
1. Пользователь открывает страницу каталога
2. Система загружает список публичных экспонатов из базы данных
3. Применяются фильтры (если заданы):
   - По категории
   - По году создания
   - По наличию 3D модели
4. Применяется поисковый запрос (если задан):
   - Поиск по названию, описанию, категории, автору, руководителю
5. Результаты сортируются по дате создания (новые первыми)
6. Применяется пагинация (6 экспонатов на страницу)
7. Отображаются карточки экспонатов с превью-изображениями
8. Пользователь может кликнуть на карточку для перехода к детальной странице
```

**Алгоритм работы виртуальной галереи:**

```
1. Пользователь открывает страницу виртуальной галереи
2. Система инициализирует Three.js сцену и камеру
3. Загружаются экспонаты с visibleInGallery = true
4. Для каждого экспоната:
   a. Если есть 3D модель (has3DModel = true):
      - Загружается GLB/GLTF модель из modelPath
      - Позиционируется по координатам (galleryPositionX, Y, Z)
      - Применяется масштаб (galleryScale)
      - Применяется поворот (galleryRotationY)
   b. Если нет 3D модели:
      - Создается плоскость с превью-изображением
      - Позиционируется аналогично
5. Инициализируются контроллеры камеры (FirstPersonControls)
6. Запускается игровой цикл рендеринга (requestAnimationFrame)
7. При клике на экспонат:
   - Открывается модальное окно с детальной информацией
   - Или происходит переход на страницу экспоната
```

**Алгоритм работы административной панели:**

```
1. Администратор вводит логин и пароль
2. Система проверяет учетные данные
3. При успешной аутентификации:
   - Сохраняется сессия в localStorage и cookies
   - Устанавливается роль (admin/super)
4. Администратор получает доступ к функциям:
   a. Просмотр списка всех экспонатов
   b. Создание нового экспоната:
      - Заполнение формы с данными
      - Загрузка изображений
      - Загрузка 3D модели (опционально)
      - Создание или выбор научного руководителя
      - Сохранение в базу данных
   c. Редактирование экспоната:
      - Загрузка существующих данных
      - Изменение полей
      - Обновление медиа-файлов
      - Сохранение изменений
   d. Удаление экспоната
   e. Редактирование позиции в галерее (для super-admin):
      - Открытие редактора галереи
      - Перемещение экспоната в 3D пространстве
      - Сохранение координат, масштаба, поворота
```

### 4.1.2 Алгоритм поиска и фильтрации

**Алгоритм поиска:**

```javascript
function searchExhibits(query, exhibits) {
  const lowerQuery = query.toLowerCase()
  const queryWords = lowerQuery.split(' ').filter(w => w.length > 0)
  
  return exhibits.filter(exhibit => {
    const searchableText = [
      exhibit.title,
      exhibit.description,
      exhibit.category,
      exhibit.studentName,
      exhibit.supervisor?.name
    ].join(' ').toLowerCase()
    
    return queryWords.some(word => 
      searchableText.includes(word)
    )
  })
}
```

**Алгоритм фильтрации:**

```javascript
function filterExhibits(exhibits, filters) {
  return exhibits.filter(exhibit => {
    // Фильтр по категории
    if (filters.category && exhibit.category !== filters.category) {
      return false
    }
    
    // Фильтр по году
    if (filters.year && exhibit.year !== filters.year) {
      return false
    }
    
    // Фильтр по наличию 3D модели
    if (filters.only3D && !exhibit.has3DModel) {
      return false
    }
    
    return true
  })
}
```

### 4.1.3 Алгоритм позиционирования в 3D галерее

**Алгоритм размещения экспоната:**

```
1. Администратор открывает редактор галереи
2. Загружаются все экспонаты с visibleInGallery = true
3. Экспонаты отображаются в 3D пространстве
4. Администратор выбирает экспонат для редактирования
5. При перемещении экспоната:
   a. Обновляются координаты в реальном времени
   b. Проверяется расстояние до других экспонатов (опционально)
   c. Визуально отображается новая позиция
6. При изменении масштаба:
   a. Обновляется значение galleryScale
   b. Применяется трансформация к модели
7. При повороте:
   a. Обновляется значение galleryRotationY
   b. Применяется поворот вокруг оси Y
8. При сохранении:
   a. Отправляется PUT запрос к API
   b. Обновляется запись в базе данных
   c. Изменения применяются в галерее
```

### 4.1.4 Алгоритм загрузки и обработки файлов

**Алгоритм загрузки изображения:**

```
1. Пользователь выбирает файл в форме
2. Проверяется тип файла (должен быть изображением)
3. Проверяется размер файла (< 10 MB)
4. Генерируется уникальное имя файла (UUID + timestamp)
5. Файл сохраняется в public/images/
6. Путь к файлу возвращается в ответе
7. Путь сохраняется в поле previewImage или добавляется в массив images
```

**Алгоритм загрузки 3D модели:**

```
1. Пользователь выбирает GLB/GLTF файл
2. Проверяется расширение файла (.glb или .gltf)
3. Проверяется размер файла (< 50 MB)
4. Генерируется уникальное имя файла
5. Файл сохраняется в public/models/
6. Путь к файлу сохраняется в поле modelPath
7. Устанавливается флаг has3DModel = true
```

## 4.2 Определение формы представления входных и выходных данных

### 4.2.1 Входные данные

**Форма создания/редактирования экспоната:**

Входные данные представлены в виде структурированной формы с валидацией:

```typescript
interface ExhibitFormData {
  // Обязательные поля
  title: string                    // Название экспоната
  description: string              // Краткое описание
  category: string                 // Категория
  
  // Опциональные поля
  inventoryNumber?: string          // Инвентарный номер
  fullDescription?: string         // Полное описание
  creationDate?: string            // Дата создания
  studentName?: string             // ФИО студента
  studentCourse?: string           // Курс
  studentGroup?: string            // Группа
  supervisor?: {                   // Научный руководитель
    name: string
    position?: string
    rank?: string
    department?: string
  }
  dimensions?: string              // Размеры
  currentLocation?: string         // Местонахождение
  isPublic: boolean               // Публичность
  
  // Медиа-файлы
  previewImage?: File              // Превью-изображение (файл)
  images?: File[]                  // Галерея изображений (файлы)
  modelFile?: File                 // 3D модель (файл)
  
  // Дополнительные данные
  creationInfo?: string            // Информация о создании
  technicalSpecs?: Record<string, string>  // Технические характеристики
  interestingFacts?: string[]       // Интересные факты
  relatedExhibits?: string[]       // Связанные экспонаты (ID)
  
  // Позиционирование в галерее
  galleryPositionX?: number
  galleryPositionY?: number
  galleryPositionZ?: number
  galleryScale?: number
  galleryRotationY?: number
  visibleInGallery: boolean
}
```

**Форма поиска и фильтрации:**

```typescript
interface SearchFilters {
  query?: string           // Поисковый запрос
  category?: string        // Фильтр по категории
  year?: string           // Фильтр по году
  only3D?: boolean        // Только с 3D моделями
  page?: number           // Номер страницы для пагинации
}
```

**Данные аутентификации:**

```typescript
interface AuthData {
  login: string           // Логин администратора
  password: string        // Пароль
}
```

### 4.2.2 Выходные данные

**Список экспонатов (API ответ):**

```typescript
interface ExhibitResponse {
  id: string
  inventoryNumber?: string
  title: string
  description: string
  fullDescription?: string
  creationDate?: string
  studentName?: string
  studentCourse?: string
  studentGroup?: string
  supervisor?: {
    id: string
    name: string
    position?: string
    rank?: string
    department?: string
  }
  dimensions?: string
  currentLocation?: string
  isPublic: boolean
  category: string
  year?: string
  modelPath?: string
  has3DModel: boolean
  previewImage?: string
  images: string[]        // Массив путей к изображениям
  creationInfo?: string
  technicalSpecs: Record<string, string>
  interestingFacts: string[]
  relatedExhibits: string[]
  galleryPositionX?: number
  galleryPositionY?: number
  galleryPositionZ?: number
  galleryScale?: number
  galleryRotationY?: number
  visibleInGallery: boolean
  createdAt: string       // ISO дата
  updatedAt: string       // ISO дата
}
```

**Представление в каталоге (карточка экспоната):**

Визуальное представление включает:
- Превью-изображение (300x300px, обрезанное)
- Название экспоната
- Категория (бейдж)
- Год создания
- Кнопка "Подробнее"

**Представление на детальной странице:**

Полная информация об экспонате:
- Заголовок с названием
- Галерея изображений (слайдер)
- Полное описание
- Информация об авторе (ФИО, курс, группа)
- Информация о научном руководителе
- Дополнительные характеристики (размеры, местонахождение)
- 3D модель (если имеется) с интерактивным просмотром
- QR-код для быстрого доступа
- Навигация (предыдущий/следующий экспонат)

**Представление в виртуальной галерее:**

3D представление экспоната:
- 3D модель (если has3DModel = true) или плоскость с изображением
- Позиционирование по координатам (X, Y, Z)
- Масштаб и поворот
- Интерактивное взаимодействие (клик для открытия деталей)

**QR-код:**

Визуальное представление:
- QR-код в формате PNG/SVG
- Ссылка на страницу экспоната: `/exhibit/{id}`
- Размер: 200x200px для отображения на сайте
- Размер: 300x300px для печати

### 4.2.3 Форматы данных

**JSON для API:**

Все API endpoints возвращают данные в формате JSON с кодировкой UTF-8:

```json
{
  "id": "uuid",
  "title": "Название",
  "description": "Описание",
  ...
}
```

**Изображения:**

- Форматы: JPEG, PNG, WebP
- Рекомендуемый размер превью: 800x800px
- Максимальный размер файла: 10 MB
- Оптимизация через Next.js Image

**3D модели:**

- Формат: GLB (бинарный GLTF)
- Альтернативный формат: GLTF (JSON + бинарные данные)
- Максимальный размер: 50 MB
- Рекомендуемое количество полигонов: < 50,000

**QR-коды:**

- Формат: PNG (для отображения) или SVG (для печати)
- Размер: 200x200px (веб) или 300x300px (печать)
- Коррекция ошибок: уровень M (15%)

## 4.3 Тестирование программного модуля

Тестирование программного модуля проводилось на различных этапах разработки для обеспечения корректности работы всех компонентов системы.

### 4.3.1 Функциональное тестирование

**Тест 1: Создание экспоната**

**Цель:** Проверить корректность создания нового экспоната через административную панель.

**Шаги:**
1. Войти в систему как администратор
2. Перейти в раздел "Управление экспонатами"
3. Нажать кнопку "Создать экспонат"
4. Заполнить обязательные поля: название, описание, категория
5. Загрузить превью-изображение
6. Заполнить дополнительные поля (автор, руководитель)
7. Нажать "Сохранить"

**Ожидаемый результат:** Экспонат успешно создан, отображается в списке, доступен в каталоге (если isPublic = true).

**Результат:** ✅ Тест пройден. Экспонат создается корректно, все данные сохраняются в базу данных.

---

**Тест 2: Поиск экспонатов**

**Цель:** Проверить корректность работы поиска по каталогу.

**Шаги:**
1. Открыть страницу каталога
2. Ввести поисковый запрос в поле поиска (например, название экспоната)
3. Нажать "Найти" или дождаться автоматического поиска

**Ожидаемый результат:** Отображаются только экспонаты, соответствующие поисковому запросу (по названию, описанию, категории, автору, руководителю).

**Результат:** ✅ Тест пройден. Поиск работает корректно, находит экспонаты по всем указанным критериям.

---

**Тест 3: Фильтрация по категориям**

**Цель:** Проверить корректность фильтрации экспонатов по категориям.

**Шаги:**
1. Открыть страницу каталога
2. Выбрать категорию из выпадающего списка
3. Дождаться применения фильтра

**Ожидаемый результат:** Отображаются только экспонаты выбранной категории.

**Результат:** ✅ Тест пройден. Фильтрация работает корректно.

---

**Тест 4: Просмотр детальной страницы экспоната**

**Цель:** Проверить корректность отображения полной информации об экспонате.

**Шаги:**
1. Открыть каталог
2. Кликнуть на карточку экспоната
3. Проверить отображение всех данных

**Ожидаемый результат:** Отображается полная информация: название, описание, галерея изображений, информация об авторе и руководителе, дополнительные характеристики.

**Результат:** ✅ Тест пройден. Все данные отображаются корректно.

---

**Тест 5: Редактирование экспоната**

**Цель:** Проверить корректность обновления данных экспоната.

**Шаги:**
1. Войти как администратор
2. Открыть список экспонатов
3. Выбрать экспонат для редактирования
4. Изменить некоторые поля
5. Сохранить изменения

**Ожидаемый результат:** Изменения сохранены, отображаются на странице экспоната.

**Результат:** ✅ Тест пройден. Редактирование работает корректно.

---

**Тест 6: Удаление экспоната**

**Цель:** Проверить корректность удаления экспоната.

**Шаги:**
1. Войти как администратор
2. Открыть список экспонатов
3. Выбрать экспонат для удаления
4. Нажать кнопку "Удалить"
5. Подтвердить удаление

**Ожидаемый результат:** Экспонат удален из базы данных, не отображается в каталоге и списке.

**Результат:** ✅ Тест пройден. Удаление работает корректно.

---

**Тест 7: Загрузка изображений**

**Цель:** Проверить корректность загрузки и сохранения изображений.

**Шаги:**
1. Войти как администратор
2. Создать или отредактировать экспонат
3. Загрузить изображение (JPEG, PNG)
4. Сохранить экспонат

**Ожидаемый результат:** Изображение загружено, сохранено в public/images/, путь сохранен в базе данных, изображение отображается на странице экспоната.

**Результат:** ✅ Тест пройден. Загрузка изображений работает корректно.

---

**Тест 8: Виртуальная 3D галерея**

**Цель:** Проверить корректность работы виртуальной галереи.

**Шаги:**
1. Открыть страницу виртуальной галереи
2. Дождаться загрузки 3D сцены
3. Использовать WASD для навигации
4. Кликнуть на экспонат

**Ожидаемый результат:** Галерея загружается, экспонаты отображаются в 3D пространстве, навигация работает, при клике открывается информация об экспонате.

**Результат:** ✅ Тест пройден. Виртуальная галерея работает корректно.

---

**Тест 9: Позиционирование экспонатов в галерее**

**Цель:** Проверить корректность редактирования позиции экспонатов в 3D пространстве.

**Шаги:**
1. Войти как super-admin
2. Открыть редактор галереи
3. Выбрать экспонат
4. Переместить его в 3D пространстве
5. Изменить масштаб и поворот
6. Сохранить изменения

**Ожидаемый результат:** Изменения сохранены в базу данных, экспонат отображается в новой позиции в галерее.

**Результат:** ✅ Тест пройден. Редактирование позиции работает корректно.

---

**Тест 10: Генерация QR-кодов**

**Цель:** Проверить корректность генерации QR-кодов для экспонатов.

**Шаги:**
1. Открыть страницу экспоната
2. Проверить наличие QR-кода
3. Отсканировать QR-код с помощью мобильного устройства

**Ожидаемый результат:** QR-код отображается, при сканировании открывается страница экспоната.

**Результат:** ✅ Тест пройден. Генерация и сканирование QR-кодов работает корректно.

### 4.3.2 Тестирование производительности

**Тест производительности загрузки каталога:**

- **Количество экспонатов:** 100
- **Время загрузки:** < 1 секунды
- **Результат:** ✅ Удовлетворительно

**Тест производительности поиска:**

- **Количество экспонатов:** 100
- **Время поиска:** < 500 мс
- **Результат:** ✅ Удовлетворительно

**Тест производительности виртуальной галереи:**

- **Количество экспонатов в галерее:** 20
- **Время загрузки:** < 5 секунд
- **FPS в галерее:** 30-60 FPS
- **Результат:** ✅ Удовлетворительно

### 4.3.3 Тестирование совместимости

**Браузеры:**
- Chrome 90+: ✅ Работает корректно
- Firefox 88+: ✅ Работает корректно
- Safari 14+: ✅ Работает корректно
- Edge 90+: ✅ Работает корректно

**Устройства:**
- Десктоп (1920x1080): ✅ Работает корректно
- Планшет (768x1024): ✅ Работает корректно
- Мобильный (375x667): ✅ Работает корректно

### 4.3.4 Тестирование безопасности

**Тест валидации файлов:**
- Загрузка недопустимого типа файла: ✅ Блокируется
- Загрузка файла превышающего размер: ✅ Блокируется

**Тест аутентификации:**
- Неверный логин/пароль: ✅ Доступ запрещен
- Правильный логин/пароль: ✅ Доступ предоставлен

## 4.4 Разработка справочной системы

Справочная система реализована в виде встроенных подсказок и инструкций непосредственно в интерфейсе приложения.

### 4.4.1 Справочная информация для пользователей

**На главной странице:**
- Описание проекта в секции "О виртуальной галерее"
- Инструкции по использованию в секции "Как это работает"
- Навигационные подсказки

**В каталоге:**
- Подсказка в поле поиска: "Введите название, описание или имя автора..."
- Описание фильтров при наведении
- Информация о количестве найденных работ

**На странице экспоната:**
- Описание каждого блока информации
- Инструкция по использованию 3D модели (если имеется)
- Описание QR-кода: "Отсканируйте для быстрого доступа"

**В виртуальной галерее:**
- Инструкция по управлению при первом открытии:
  - WASD — движение
  - Мышь — поворот камеры
  - Клик на экспонат — открыть детали
- Подсказки отображаются в виде overlay при необходимости

### 4.4.2 Справочная информация для администраторов

**В административной панели:**
- Описание каждого поля формы при создании/редактировании экспоната
- Требования к загружаемым файлам (форматы, размеры)
- Инструкции по заполнению полей

**В редакторе галереи:**
- Инструкция по позиционированию экспонатов
- Описание горячих клавиш
- Подсказки по сохранению изменений

**В редакторе контента страниц:**
- Описание структуры JSON для редактирования
- Примеры форматирования текста
- Предупреждения о важных полях

### 4.4.3 Техническая документация

**README.md:**
- Описание проекта
- Инструкции по установке и запуску
- Структура проекта
- Команды для разработки

**API документация (в коде):**
- Комментарии к каждому API endpoint
- Описание параметров запросов
- Примеры использования

**Схема базы данных:**
- Описание в файле `prisma/schema.prisma`
- Комментарии к полям моделей
- Описание связей между таблицами

### 4.4.4 Форматы справочной информации

Справочная информация представлена в следующих форматах:

1. **Встроенные подсказки** — tooltips при наведении на элементы интерфейса
2. **Информационные блоки** — выделенные секции с инструкциями
3. **Модальные окна** — для важных инструкций при первом использовании
4. **Текстовая документация** — Markdown файлы в репозитории

Все справочные материалы доступны на русском языке и адаптированы для пользователей с различным уровнем технической подготовки.
