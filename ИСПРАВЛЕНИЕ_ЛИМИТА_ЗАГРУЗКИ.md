# Исправление ошибки 413 (Request Entity Too Large) при загрузке 3D моделей

Ошибка возникает из-за ограничений размера загружаемых файлов в Nginx и Next.js.

## Что было исправлено в коде:

1. ✅ Увеличен лимит в `next.config.js` до 100MB
2. ✅ Добавлены настройки в `app/api/upload/route.ts` (maxDuration)
3. ✅ Увеличен лимит в `nginx-ip-config.conf` до 100MB

## Что нужно сделать на сервере:

### 1. Проверить и обновить конфигурацию Nginx

Сначала проверьте текущую конфигурацию:

```bash
# Найти все конфигурационные файлы Nginx
sudo find /etc/nginx -name "*.conf" -type f | xargs grep -l "devsu.site\|museum-app\|client_max_body_size"

# Проверить текущий лимит
sudo grep -r "client_max_body_size" /etc/nginx/

# Проверить активную конфигурацию для домена devsu.site
sudo cat /etc/nginx/sites-enabled/* | grep -A 5 -B 5 "devsu.site\|server_name"
```

Затем обновите конфигурацию:

**Вариант А: Если используется файл museum-app:**
```bash
# Скопировать обновленную конфигурацию (ВАЖНО: используйте абсолютный путь!)
sudo cp /root/Scan/nginx-ip-config.conf /etc/nginx/sites-available/museum-app

# Или отредактировать существующую конфигурацию
sudo nano /etc/nginx/sites-available/museum-app
```

**Вариант Б: Если используется другой файл конфигурации (например, для devsu.site):**
```bash
# Найти файл конфигурации
sudo ls -la /etc/nginx/sites-available/

# Отредактировать нужный файл
sudo nano /etc/nginx/sites-available/название-файла.conf
```

**В любом случае убедитесь, что в конфигурации есть:**
```nginx
client_max_body_size 100M;
```

**ВАЖНО:** Если используется SSL (HTTPS), нужно обновить конфигурацию для порта 443 тоже!

После редактирования:
```bash
# Проверить конфигурацию на ошибки
sudo nginx -t

# Если проверка прошла успешно, перезагрузить Nginx
sudo systemctl reload nginx

# Проверить, что изменения применились
sudo nginx -T | grep client_max_body_size
```

### 2. Пересобрать и перезапустить приложение

```bash
cd /root/Scan

# Если используется Docker
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml build
docker-compose -f docker-compose.prod.yml up -d

# Если без Docker
npm run build
pm2 restart museum-app
```

### 3. Проверить переменные окружения (опционально)

Если проблема сохраняется, можно добавить переменную окружения в `.env`:

```bash
# Добавить в .env файл
NEXT_BODY_SIZE_LIMIT=104857600  # 100MB в байтах
```

## Быстрое исправление для devsu.site

Если у вас конфигурация для `devsu.site` (как на скриншоте), нужно добавить `client_max_body_size` в оба server блока:

```bash
# Отредактировать конфигурацию
sudo nano /etc/nginx/sites-available/devsu.site
```

**Добавьте строку `client_max_body_size 100M;` в ОБА server блока:**

1. **В server блок для HTTPS (порт 443)** - добавьте после `server_name`:
```nginx
server {
    listen 443 ssl;
    server_name devsu.site www.deusu.site;
    
    client_max_body_size 100M;  # <-- ДОБАВЬТЕ ЭТУ СТРОКУ
    
    ssl_certificate /etc/letsencrypt/live/deusu.site/fullchain.pem;
    # ... остальная конфигурация
}
```

2. **В server блок для HTTP (порт 80)** - добавьте после `server_name`:
```nginx
server {
    listen 80;
    server_name devsu.site www.deusu.site;
    
    client_max_body_size 100M;  # <-- ДОБАВЬТЕ ЭТУ СТРОКУ
    
    # ... остальная конфигурация
}
```

**Сохраните файл:**
- Нажмите `Ctrl+O` (сохранить)
- Нажмите `Enter` (подтвердить имя файла)
- Нажмите `Ctrl+X` (выйти)

**Проверьте и перезагрузите:**
```bash
sudo nginx -t  # Проверить конфигурацию
sudo systemctl reload nginx  # Перезагрузить
```

## Проверка

После применения изменений попробуйте загрузить 3D модель снова. Теперь должны поддерживаться файлы до 100MB.

**Проверьте, что изменения применились:**
```bash
# Должно показать 100M
sudo nginx -T 2>/dev/null | grep client_max_body_size
```

## Если проблема сохраняется:

1. Проверьте логи Nginx: `sudo tail -f /var/log/nginx/error.log`
2. Проверьте логи приложения: `pm2 logs museum-app` или `docker-compose logs -f`
3. Убедитесь, что файл действительно меньше 100MB
