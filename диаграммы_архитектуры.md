# Диаграммы архитектуры системы

## 1. Общая архитектурная схема системы

```mermaid
graph TB
    subgraph "Клиентская часть (Browser)"
        A[Пользователь] --> B[Next.js Frontend]
        B --> C[React Components]
        C --> D[Public Pages]
        C --> E[Admin Pages]
        C --> F[3D Gallery]
    end
    
    subgraph "Серверная часть (Next.js Server)"
        B --> G[API Routes]
        G --> H[Exhibits API]
        G --> I[Upload API]
        G --> J[Page Content API]
        G --> K[Storage API]
    end
    
    subgraph "Слой данных"
        H --> L[Prisma ORM]
        I --> L
        J --> L
        L --> M[(SQLite Database)]
        M --> N[Exhibit Table]
        M --> O[Supervisor Table]
        M --> P[PageContent Table]
    end
    
    subgraph "Файловое хранилище"
        I --> Q[public/images/]
        I --> R[public/models/]
    end
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style M fill:#e8f5e9
    style Q fill:#f3e5f5
    style R fill:#f3e5f5
```

## 2. Диаграмма компонентов и модулей

```mermaid
graph LR
    subgraph "Публичный модуль"
        A1[Главная страница<br/>app/page.tsx]
        A2[Каталог<br/>app/catalog/page.tsx]
        A3[Страница экспоната<br/>app/exhibit/[id]/page.tsx]
        A4[Виртуальная галерея<br/>app/gallery/page.tsx]
        A5[О проекте<br/>app/about/page.tsx]
    end
    
    subgraph "Административный модуль"
        B1[Админ-панель<br/>app/admin/page.tsx]
        B2[Редактор галереи<br/>app/admin/gallery/page.tsx]
        B3[Сканер QR<br/>app/camera/page.tsx]
    end
    
    subgraph "API модуль"
        C1[Exhibits API<br/>/api/exhibits]
        C2[Upload API<br/>/api/upload]
        C3[Page Content API<br/>/api/page-content]
        C4[Storage API<br/>/api/storage]
    end
    
    subgraph "Компоненты"
        D1[Navbar<br/>Footer]
        D2[ExhibitCard<br/>SafeImage]
        D3[VirtualGallery<br/>ModelViewer]
        D4[ExhibitForm<br/>ExhibitList]
        D5[FirstPersonControls<br/>MobileControls]
    end
    
    subgraph "Библиотеки"
        E1[lib/exhibits.ts]
        E2[lib/pageContent.ts]
        E3[lib/prisma.ts]
    end
    
    A1 --> D1
    A2 --> D2
    A3 --> D3
    A4 --> D3
    A4 --> D5
    B1 --> D4
    B2 --> D3
    B3 --> D1
    
    A2 --> C1
    A3 --> C1
    A4 --> C1
    B1 --> C1
    B1 --> C2
    B2 --> C1
    B3 --> C1
    
    C1 --> E1
    C3 --> E2
    E1 --> E3
    E2 --> E3
    
    style A1 fill:#e3f2fd
    style A2 fill:#e3f2fd
    style A3 fill:#e3f2fd
    style A4 fill:#e3f2fd
    style B1 fill:#fff3e0
    style B2 fill:#fff3e0
    style C1 fill:#f1f8e9
    style C2 fill:#f1f8e9
    style D1 fill:#fce4ec
    style E1 fill:#e0f2f1
```

## 3. Диаграмма потоков данных

### 3.1 Поток данных при просмотре каталога

```mermaid
sequenceDiagram
    participant U as Пользователь
    participant C as Catalog Page
    participant API as /api/exhibits
    participant DB as SQLite DB
    participant Comp as ExhibitCard
    
    U->>C: Открытие страницы каталога
    C->>API: GET /api/exhibits
    API->>DB: SELECT * FROM Exhibit WHERE isPublic=true
    DB-->>API: Список экспонатов
    API-->>C: JSON массив экспонатов
    C->>C: Применение фильтров и поиска
    C->>C: Пагинация (6 на страницу)
    C->>Comp: Рендеринг карточек
    Comp-->>U: Отображение каталога
    
    U->>C: Ввод поискового запроса
    C->>C: Фильтрация по запросу
    C->>Comp: Обновление карточек
    Comp-->>U: Обновленный список
    
    U->>Comp: Клик на карточку
    Comp->>U: Переход на /exhibit/[id]
```

### 3.2 Поток данных при создании экспоната

```mermaid
sequenceDiagram
    participant A as Администратор
    participant F as ExhibitForm
    participant U as Upload API
    participant E as Exhibits API
    participant S as Supervisor API
    participant DB as SQLite DB
    
    A->>F: Заполнение формы
    A->>F: Загрузка изображения
    F->>U: POST /api/upload (image)
    U-->>F: Путь к файлу
    F->>F: Сохранение пути
    
    A->>F: Загрузка 3D модели
    F->>U: POST /api/upload (model)
    U-->>F: Путь к файлу
    F->>F: Сохранение пути
    
    A->>F: Ввод данных руководителя
    F->>E: POST /api/exhibits
    E->>S: Поиск/создание Supervisor
    S->>DB: SELECT/INSERT Supervisor
    DB-->>S: ID руководителя
    S-->>E: supervisorId
    
    E->>DB: INSERT INTO Exhibit
    DB-->>E: Созданный экспонат
    E-->>F: Успешное создание
    F-->>A: Сообщение об успехе
```

### 3.3 Поток данных в виртуальной галерее

```mermaid
sequenceDiagram
    participant U as Пользователь
    participant G as Gallery Page
    participant API as /api/exhibits
    participant DB as SQLite DB
    participant VG as VirtualGallery
    participant T as Three.js Scene
    
    U->>G: Открытие галереи
    G->>API: GET /api/exhibits
    API->>DB: SELECT * FROM Exhibit WHERE visibleInGallery=true
    DB-->>API: Список экспонатов
    API-->>G: JSON массив
    
    G->>VG: Инициализация компонента
    VG->>T: Создание сцены и камеры
    
    loop Для каждого экспоната
        VG->>VG: Проверка has3DModel
        alt Есть 3D модель
            VG->>VG: Загрузка GLB/GLTF
            VG->>T: Добавление модели в сцену
        else Нет 3D модели
            VG->>VG: Создание плоскости с изображением
            VG->>T: Добавление плоскости в сцену
        end
        VG->>T: Позиционирование (X, Y, Z)
        VG->>T: Применение масштаба и поворота
    end
    
    VG->>VG: Инициализация FirstPersonControls
    VG->>T: Запуск render loop
    T-->>U: Отображение 3D галереи
    
    U->>VG: Навигация (WASD)
    VG->>T: Обновление позиции камеры
    T-->>U: Обновление вида
    
    U->>VG: Клик на экспонат
    VG->>G: Открытие модального окна
    G-->>U: Информация об экспонате
```

### 3.4 Поток данных при поиске и фильтрации

```mermaid
flowchart TD
    A[Пользователь вводит запрос] --> B[Catalog Page получает данные]
    B --> C{Применение фильтров}
    C -->|По категории| D[Фильтр по category]
    C -->|По году| E[Фильтр по year]
    C -->|Только 3D| F[Фильтр по has3DModel]
    D --> G[Применение поиска]
    E --> G
    F --> G
    G --> H{Поисковый запрос?}
    H -->|Да| I[Поиск по title, description,<br/>category, studentName, supervisor]
    H -->|Нет| J[Все отфильтрованные экспонаты]
    I --> K[Сортировка по createdAt]
    J --> K
    K --> L[Применение пагинации]
    L --> M[Отображение 6 экспонатов]
    M --> N[Рендеринг ExhibitCard]
    N --> O[Отображение пользователю]
    
    style A fill:#e1f5ff
    style O fill:#c8e6c9
    style G fill:#fff9c4
```

### 3.5 Поток данных при редактировании позиции в галерее

```mermaid
sequenceDiagram
    participant SA as Super-Admin
    participant GE as Gallery Editor
    participant API as /api/exhibits/[id]
    participant DB as SQLite DB
    participant VG as VirtualGallery
    
    SA->>GE: Открытие редактора
    GE->>API: GET /api/exhibits
    API->>DB: SELECT * FROM Exhibit
    DB-->>API: Все экспонаты
    API-->>GE: JSON массив
    GE->>VG: Отображение экспонатов
    
    SA->>GE: Выбор экспоната
    GE->>GE: Загрузка текущих координат
    
    loop Редактирование позиции
        SA->>GE: Перемещение экспоната
        GE->>GE: Обновление координат X, Y, Z
        GE->>VG: Визуальное обновление
        
        SA->>GE: Изменение масштаба
        GE->>GE: Обновление galleryScale
        GE->>VG: Визуальное обновление
        
        SA->>GE: Поворот экспоната
        GE->>GE: Обновление galleryRotationY
        GE->>VG: Визуальное обновление
    end
    
    SA->>GE: Сохранение изменений
    GE->>API: PUT /api/exhibits/[id]
    API->>DB: UPDATE Exhibit SET<br/>galleryPositionX, Y, Z,<br/>galleryScale, galleryRotationY
    DB-->>API: Обновленный экспонат
    API-->>GE: Успешное сохранение
    GE-->>SA: Сообщение об успехе
```

## 4. Диаграмма структуры базы данных

```mermaid
erDiagram
    EXHIBIT ||--o{ SUPERVISOR : "имеет"
    EXHIBIT {
        string id PK
        string inventoryNumber
        string title
        string description
        string fullDescription
        string creationDate
        string studentName
        string studentCourse
        string studentGroup
        string supervisorId FK
        string dimensions
        string currentLocation
        boolean isPublic
        string category
        string year
        string modelPath
        boolean has3DModel
        string previewImage
        string images
        string creationInfo
        string technicalSpecs
        string interestingFacts
        string relatedExhibits
        float galleryPositionX
        float galleryPositionY
        float galleryPositionZ
        float galleryScale
        float galleryRotationY
        boolean visibleInGallery
        datetime createdAt
        datetime updatedAt
    }
    
    SUPERVISOR ||--o{ EXHIBIT : "курирует"
    SUPERVISOR {
        string id PK
        string name UK
        string position
        string rank
        string department
        datetime createdAt
        datetime updatedAt
    }
    
    PAGECONTENT {
        string id PK
        string content
        datetime updatedAt
    }
```

## 5. Диаграмма взаимодействия модулей

```mermaid
graph TD
    subgraph "Frontend Layer"
        A[Public Pages]
        B[Admin Pages]
        C[3D Gallery]
    end
    
    subgraph "API Layer"
        D[Exhibits API]
        E[Upload API]
        F[Page Content API]
    end
    
    subgraph "Business Logic Layer"
        G[lib/exhibits.ts]
        H[lib/pageContent.ts]
    end
    
    subgraph "Data Access Layer"
        I[Prisma ORM]
    end
    
    subgraph "Data Storage"
        J[(SQLite Database)]
        K[File System]
    end
    
    A --> D
    A --> F
    B --> D
    B --> E
    B --> F
    C --> D
    
    D --> G
    E --> K
    F --> H
    
    G --> I
    H --> I
    
    I --> J
    
    style A fill:#e3f2fd
    style B fill:#fff3e0
    style D fill:#f1f8e9
    style I fill:#e0f2f1
    style J fill:#c8e6c9
```

## Описание диаграмм

### Общая архитектурная схема

Схема показывает трехуровневую архитектуру системы: клиентская часть (браузер с Next.js Frontend), серверная часть (Next.js Server с API Routes) и слой данных (Prisma ORM и SQLite Database). Также показано файловое хранилище для медиа-контента.

### Диаграмма компонентов и модулей

Диаграмма демонстрирует структуру приложения, разделенную на публичный модуль, административный модуль, API модуль, компоненты и библиотеки. Показаны связи между компонентами и их использование в различных частях приложения.

### Диаграмма потоков данных

Диаграммы потоков данных описывают последовательность операций для ключевых сценариев использования: просмотр каталога, создание экспоната, работа виртуальной галереи, поиск и фильтрация, редактирование позиции в галерее. Каждая диаграмма показывает взаимодействие между компонентами системы и передачу данных.

### Диаграмма структуры базы данных

ER-диаграмма показывает структуру базы данных с тремя основными таблицами: Exhibit, Supervisor и PageContent. Показаны связи между таблицами, основные поля и типы данных.

### Диаграмма взаимодействия модулей

Диаграмма демонстрирует слоистую архитектуру приложения с разделением на Frontend Layer, API Layer, Business Logic Layer, Data Access Layer и Data Storage. Показаны направления взаимодействия между слоями.
