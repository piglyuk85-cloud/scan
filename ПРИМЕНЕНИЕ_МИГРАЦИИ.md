# Применение миграции базы данных на сервере

После приведения базы данных к третьей нормальной форме необходимо применить миграцию на сервере.

⚠️ **ВАЖНО:** Если миграция уже пыталась выполниться и упала с ошибкой `UNIQUE constraint failed`, сначала выполните инструкции из файла `ИСПРАВЛЕНИЕ_МИГРАЦИИ.md`.

## Вариант 1: Если используется Docker

Выполните следующие команды на сервере:

```bash
# Перейдите в директорию проекта
cd ~/Scan

# Примените миграцию внутри Docker контейнера
docker-compose -f docker-compose.prod.yml run --rm virtual-gallery npx prisma migrate deploy

# Перегенерируйте Prisma Client
docker-compose -f docker-compose.prod.yml run --rm virtual-gallery npx prisma generate

# Перезапустите приложение
docker-compose -f docker-compose.prod.yml restart
```

## Вариант 2: Если приложение запущено без Docker

Выполните на сервере:

```bash
# Перейдите в директорию проекта
cd /root/Scan

# Примените миграцию
npx prisma migrate deploy

# Перегенерируйте Prisma Client
npx prisma generate

# Перезапустите приложение (если используется PM2)
pm2 restart museum-app
# или
npm run build
npm start
```

## Важно!

⚠️ **Перед применением миграции сделайте резервную копию базы данных:**

```bash
# Если используется Docker
docker-compose -f docker-compose.prod.yml exec virtual-gallery cp prisma/prod.db prisma/prod.db.backup.$(date +%Y%m%d_%H%M%S)

# Если без Docker
cp prisma/prod.db prisma/prod.db.backup.$(date +%Y%m%d_%H%M%S)
```

## Проверка после применения

После применения миграции проверьте, что:
1. Приложение запускается без ошибок
2. Таблица `Supervisor` создана
3. Колонка `supervisorId` существует в таблице `Exhibit`
4. Старые колонки `supervisor`, `supervisorPosition`, `supervisorRank`, `supervisorDepartment` удалены из таблицы `Exhibit`

Проверить структуру базы данных можно командой:
```bash
# В Docker
docker-compose -f docker-compose.prod.yml exec virtual-gallery npx prisma db pull

# Без Docker
npx prisma db pull
```
