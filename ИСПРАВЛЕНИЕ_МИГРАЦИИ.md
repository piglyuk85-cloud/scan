# Исправление проблемы с миграцией normalize_supervisor_to_3nf

Если миграция упала с ошибкой `UNIQUE constraint failed: Supervisor.name`, это означает, что в базе данных есть дублирующиеся имена руководителей.

## Решение проблемы

### Шаг 1: Откатить неудачную миграцию

На сервере выполните:

```bash
cd /root/Scan

# Если используется Docker
docker-compose -f docker-compose.prod.yml exec virtual-gallery npx prisma migrate resolve --rolled-back 20260121000000_normalize_supervisor_to_3nf

# Если без Docker
npx prisma migrate resolve --rolled-back 20260121000000_normalize_supervisor_to_3nf
```

### Шаг 2: Исправить дубликаты в базе данных

Если таблица `Supervisor` уже создана, но содержит дубликаты:

```bash
# Если используется Docker
docker-compose -f docker-compose.prod.yml exec virtual-gallery sqlite3 prisma/prod.db < scripts/fix-migration-issue.sql

# Если без Docker
sqlite3 prisma/prod.db < scripts/fix-migration-issue.sql
```

Или вручную через SQLite:

```bash
sqlite3 prisma/prod.db
```

Затем выполните SQL:

```sql
-- Удаляем дубликаты, оставляя только первую запись для каждого имени
DELETE FROM "Supervisor"
WHERE "id" NOT IN (
    SELECT MIN("id")
    FROM "Supervisor"
    GROUP BY "name"
);
```

### Шаг 3: Применить миграцию заново

После исправления дубликатов примените миграцию:

```bash
# Если используется Docker
docker-compose -f docker-compose.prod.yml run --rm virtual-gallery npx prisma migrate deploy

# Если без Docker
npx prisma migrate deploy
```

### Шаг 4: Перегенерировать Prisma Client

```bash
# Если используется Docker
docker-compose -f docker-compose.prod.yml run --rm virtual-gallery npx prisma generate

# Если без Docker
npx prisma generate
```

### Шаг 5: Перезапустить приложение

```bash
# Если используется Docker
docker-compose -f docker-compose.prod.yml restart

# Если без Docker
pm2 restart museum-app
```

## Альтернативный вариант: Ручное исправление

Если автоматическое исправление не работает, можно вручную:

1. **Проверить текущее состояние базы данных:**
```bash
sqlite3 prisma/prod.db ".schema Supervisor"
sqlite3 prisma/prod.db "SELECT name, COUNT(*) FROM Supervisor GROUP BY name HAVING COUNT(*) > 1;"
```

2. **Удалить таблицу Supervisor, если она создана неправильно:**
```sql
DROP TABLE IF EXISTS "Supervisor";
```

3. **Применить исправленную миграцию:**
```bash
npx prisma migrate deploy
```

## Проверка после исправления

Убедитесь, что:
- Таблица `Supervisor` создана и не содержит дубликатов
- Колонка `supervisorId` существует в таблице `Exhibit`
- Приложение запускается без ошибок

```bash
sqlite3 prisma/prod.db "SELECT COUNT(DISTINCT name) as unique_names, COUNT(*) as total FROM Supervisor;"
```

Если `unique_names == total`, значит дубликатов нет.
