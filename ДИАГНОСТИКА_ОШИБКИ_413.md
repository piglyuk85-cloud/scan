# Диагностика ошибки 413 при загрузке 3D моделей

Ошибка 413 (Request Entity Too Large) возникает при загрузке файла размером 4MB, что указывает на проблему не в размере файла, а в конфигурации или коде.

## Возможные причины после нормализации БД:

1. **Проблема с Nginx конфигурацией** - лимит `client_max_body_size` может быть слишком маленьким
2. **Проблема с Next.js конфигурацией** - лимиты для API routes
3. **Проблема с обработкой FormData** в Next.js 14
4. **Проблема с путями к файлам** после изменения структуры БД

## Шаги диагностики:

### 1. Проверить логи сервера

```bash
# Логи Nginx
sudo tail -f /var/log/nginx/error.log

# Логи приложения (если PM2)
pm2 logs museum-app

# Логи приложения (если Docker)
docker-compose -f docker-compose.prod.yml logs -f virtual-gallery
```

### 2. Проверить конфигурацию Nginx

```bash
# Проверить текущую конфигурацию
sudo cat /etc/nginx/sites-available/museum-app | grep client_max_body_size

# Должно быть:
# client_max_body_size 100M;
```

### 3. Проверить, что файл действительно 4MB

В консоли браузера при загрузке проверьте размер файла:
```javascript
// В консоли браузера перед загрузкой
console.log('Размер файла:', file.size)
```

### 4. Проверить Network tab в DevTools

- Откройте DevTools → Network
- Попробуйте загрузить файл
- Посмотрите на запрос к `/api/upload`
- Проверьте Request Headers и Response

### 5. Временное решение - обойти Nginx

Если используется Nginx, попробуйте обратиться напрямую к приложению на порту 3000:
```
http://ваш-ip:3000/api/upload
```

Если это работает, проблема точно в Nginx.

### 6. Проверить переменные окружения

Убедитесь, что нет переменных окружения, которые ограничивают размер:
```bash
env | grep -i size
env | grep -i limit
```

## Быстрое исправление:

1. **Обновить Nginx конфигурацию:**
```bash
sudo nano /etc/nginx/sites-available/museum-app
# Установить: client_max_body_size 100M;
sudo nginx -t
sudo systemctl reload nginx
```

2. **Перезапустить приложение:**
```bash
pm2 restart museum-app
# или
docker-compose -f docker-compose.prod.yml restart
```

3. **Очистить кеш браузера** и попробовать снова

## Если проблема сохраняется:

Проверьте, не изменилось ли что-то в коде после нормализации БД:
- Проверьте git diff для файлов, связанных с загрузкой
- Убедитесь, что все миграции применены корректно
- Проверьте, что Prisma Client перегенерирован
